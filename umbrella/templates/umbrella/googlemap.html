{% extends 'umbrella/base.html' %}
{% load static %}
{% block content %}

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-9" style="padding: 0">
                <style>
                    html, body {
                        height: 100%;
                        margin: 0;
                        padding: 0;
                    }
                    #map {
                    {#  Below code sets height accounting for the 50px deep navbar #}
                        height: calc(100% - 50px);
                    }
                </style>
                <div id="map"></div>
                <script>
                    // Note: This example requires that you consent to location sharing when
                    // prompted by your browser. If you see the error "The Geolocation service
                    // failed.", it means you probably did not give permission for the browser to
                    // locate you.
                    var labels = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                    var labelIndex = 0;
                    var map;// set map as global variable.
                    function initMap() {
                        map = new google.maps.Map(document.getElementById('map'), {
                            center: {lat: -33.8886, lng: 151.1873},
                            zoom: 4
                        });
                        var infoWindow = new google.maps.InfoWindow({map: map});
                        // Try HTML5 geolocation.
                        if (navigator.geolocation) {
                            navigator.geolocation.getCurrentPosition(function(position) {
                                var pos = {
                                    lat: position.coords.latitude,
                                    lng: position.coords.longitude
                                };
                                infoWindow.setPosition(pos);
                                infoWindow.setContent('you are here!');
                               // map.setCenter(pos);
                            }, function() {
                                handleLocationError(true, infoWindow, map.getCenter());
                            });
                        } else {
                            // Browser doesn't support Geolocation
                            handleLocationError(false, infoWindow, map.getCenter());
                        };
                        var image = "{% static 'images/favicon.ico' %}";
                        {% for post in post_list%}
                            var post_location= { lat: {{ post.location.latitude }}, lng: {{ post.location.longitude }} };
                            var postContent = '<div id="content">'+
                            '<div id="siteNotice">'+
                            '</div>'+
                            '<h4 id="firstHeading" class="firstHeading">{{ post.post_title }}</h4>'+
                            '<div id="bodyContent" class="well well-sm">'+
                            '<p>{{ post.content }}</p>'+
                            '</div>'+
                            '</div>';
                            addMarker(post_location, image, postContent);
                        {% endfor %}
                    }
                    function addMarker(location, image, postContent) {
                        // Add the marker at the clicked location, and add the next-available label
                        // from the array of alphabetical characters.
                        var marker = new google.maps.Marker({
                            position: location,
                            label: labels[labelIndex++ % labels.length],
                            map: map,
                            icon: image
                        });
                        attachPostContent(marker, postContent); //attached the content with post
                    }
                    function attachPostContent(marker, postContent) {
                        // Add post content into icon
                        // Set counter to monitor click times: In order to improving UX
                        var infowindow = new google.maps.InfoWindow({
                            content: postContent,
                            maxWidth: 200
                        });
                        var counter = 0;
                        marker.addListener('click', function() {
                            // Double click icon can close the content
                            if (counter == 0) {
                                map.setCenter(marker.getPosition());
                                infowindow.open(marker.get('map'), marker);
                                counter=+1;
                            } else {
                                counter = 0;
                                infowindow.close(marker.get('map'), marker);
                            }
                        });
                    }
                    function sidebarClick(lat,lng) {
                        // Once click the sidebar, it will Center and Zoom to that location
                        // However, this method need to set the `map` as global variable
                        var pos = {
                            lat: lat,
                            lng: lng
                        };
                        map.setCenter(pos);
                        map.setZoom(14);
                    }
                    // Data for the markers consisting of a name, a LatLng and a zIndex for the
                    // order in which these markers should display on top of each other.
                   function handleLocationError(browserHasGeolocation, infoWindow, pos) {
                        infoWindow.setPosition(pos);
                        infoWindow.setContent(browserHasGeolocation ?
                                'Error: The Geolocation service failed.' :
                                'Error: Your browser doesn\'t support geolocation.');
                    }

                </script>
                <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBgPN0ssQZLlxZn8dFofDfWR-_hzxFAXVk&signed_in=true&callback=initMap"
                        async defer>
                </script>
            </div>
            <form class="navbar-form navbar-left" role="search">
                <div class="form-group">
                    <input type="text" class="form-control" placeholder="Search">
                </div>
                <button type="submit" class="btn btn-default">Search</button>
            </form>
            <div class="col-md-3">
                <h2>Around you</h2>
                {% for post in post_list %}
                    <a href="javascript:sidebarClick({{ post.location.latitude }}, {{ post.location.longitude }})" class="list-group-item list-group-item-info">
                        <h4 class="list-group-item-heading">
                            {{ post.post_title}}
                        </h4>
                        <p class="list-group-item-text">{{ post.content }}</p>
                    </a>
                {% endfor %}

                {#                <p>This sidebar is currently static for simplicity. A cool bonus (wishlist) could be to have a sliding sidebar :)</p>#}
                {#                <p>This sidebar will most likely be where we post &amp; update the messages.</p>#}
            </div>
        </div>
    </div>

{% endblock %}